{% extends 'userheader.html' %}
{% block content %}
<style>
    .container {
        background: #fff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        width: 100%;
        max-width: 400px;
        animation: fadeIn 1s ease-in-out;
        position: relative;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    h1 {
        text-align: center;
        color: #6a11cb;
        margin-bottom: 1.5rem;
        font-size: 2rem;
    }

    form {
        display: flex;
        flex-direction: column;
    }

    form > * {
        margin-bottom: 1rem;
    }

    input, select, textarea {
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        width: 100%;
    }

    button {
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: white;
        border: none;
        padding: 0.75rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
    }

    .back-button {
        text-align: center;
        margin-top: 1rem;
    }

    .back-button a {
        text-decoration: none;
        color: #6a11cb;
        font-weight: bold;
    }

    small.feedback-msg {
        font-size: 0.85rem;
        margin-top: -0.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    #location-error {
        color: red;
        font-size: 0.9rem;
        margin-top: -10px;
        margin-bottom: 10px;
        display: none;
    }
</style>

<div class="container">
    <h1>Book Appointment</h1>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}

        <button type="button" onclick="getLocation()">üìç Get Location</button>
        <span id="location-error">‚ùå Please click "Get Location" before submitting.</span>

        <button type="submit" id="submitBtn" disabled>Book Appointment</button>
    </form>

    <div class="back-button">
        <a href="../../../workshopdetailpage">‚Üê Back</a>
    </div>

    {% if messages %}
    <ul>
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
</div>

<script>
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                document.getElementById('id_latitude').value = position.coords.latitude;
                document.getElementById('id_longitude').value = position.coords.longitude;
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('location-error').style.display = 'none';
                alert("üìç Location captured successfully!");
            },
            function() {
                alert("‚ö†Ô∏è Unable to retrieve location.");
            }
        );
    } else {
        alert("‚ö†Ô∏è Geolocation is not supported by this browser.");
    }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const validators = [];

    function showFeedback(input, message, color) {
        let feedback = input.parentElement.querySelector('.feedback-msg');
        if (!feedback) {
            feedback = document.createElement('small');
            feedback.className = 'feedback-msg';
            input.parentElement.appendChild(feedback);
        }
        feedback.textContent = message;
        feedback.style.color = color;
    }

    function handleValidation(input, pattern, validMsg, invalidMsg) {
        function validate() {
            const value = input.value.trim();
            if (!value) {
                showFeedback(input, '‚ùå This field is required', 'red');
                return false;
            } else if (!pattern.test(value)) {
                showFeedback(input, '‚ùå ' + invalidMsg, 'red');
                return false;
            } else {
                showFeedback(input, '‚úÖ ' + validMsg, 'green');
                return true;
            }
        }
        input.addEventListener('input', validate);
        validators.push(validate);
    }

    const categoryInput = document.querySelector('[name="vehiclectegory"]');
    if (categoryInput) {
        function validateCategory() {
            if (!categoryInput.value) {
                showFeedback(categoryInput, '‚ùå Please select a vehicle category', 'red');
                return false;
            } else {
                showFeedback(categoryInput, '‚úÖ Category selected', 'green');
                return true;
            }
        }
        categoryInput.addEventListener('change', validateCategory);
        validators.push(validateCategory);
    }

    const companyInput = document.querySelector('[name="company"]');
    if (companyInput) {
        handleValidation(companyInput, /^[A-Za-z ]{2,}$/, 'Valid company name', 'Only letters and spaces (min 2 chars)');
    }

    const modelInput = document.querySelector('[name="modelname"]');
    if (modelInput) {
        handleValidation(modelInput, /^[A-Za-z0-9\- ]{2,}$/, 'Valid model name', 'Letters, numbers, hyphens (min 2 chars)');
    }

    const issueInput = document.querySelector('[name="issue"]');
    if (issueInput) {
        function validateIssue() {
            if (!issueInput.value.trim()) {
                showFeedback(issueInput, '‚ùå Please describe the issue', 'red');
                return false;
            } else {
                showFeedback(issueInput, '‚úÖ Issue noted', 'green');
                return true;
            }
        }
        issueInput.addEventListener('input', validateIssue);
        validators.push(validateIssue);
    }

    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function (e) {
            let isValid = true;

            const lat = document.getElementById('id_latitude').value;
            const lng = document.getElementById('id_longitude').value;

            if (!lat || !lng) {
                e.preventDefault();
                document.getElementById('location-error').style.display = 'block';
                return;
            }

            validators.forEach(fn => {
                if (!fn()) isValid = false;
            });

            if (!isValid) {
                e.preventDefault();
                alert('‚ùå Please correct the errors before submitting.');
            }
        });
    }
});
</script>
{% endblock %}
